document.title="rec-rec";var aa=document.createElement("meta");aa.name="viewport";aa.content="user-scalable=no,width=960";document.head.appendChild(aa);var h=document.body.style;h.background="#000";h.width=960;h.marginLeft="auto";h.marginRight="auto";c.width=960;c.height=540;c.style.background="linear-gradient(#00f,#f04)";a.fillRect(0,0,c.width,64);a.font="12px sans-serif";var ba=document.createElement("p");ba.style.color="#ddd";ba.innerHTML='Make a rap with loops! Tap anywhere on the canvas to <b>start</b>.<br>Tap on any of the 4 <b>fish</b>, it will turn <span style="color:#fa0">orange</span> when selected. On the next loop, a <span style="color:#fff">white</span> waveform will appear from the sound of the mic. Talk into your <b>mic</b> and the fish will eat the sound. From the next loop, the fish will play back the sound.<br>Tap the area above the water (at the top of the canvas) to <b>stop</b> at the end of the loop, the visualizer will turn <span style="color:#777">black</span>. Tap again to change visualizers.<br><br><b>Microphone</b> required for recording.<br>Due to lack of support for the MediaRecorder API, <b>recording will not work on iOS/Safari/Edge</b>. It works on Android/Chrome/Firefox.';
document.body.appendChild(ba);var n,ca,u,x,z,A,da,H,I,ea,L,fa=0,ha=0,na="",M,N,R=[],S="#fff #f0f #ff0 #0ff #0f0 #fa0".split(" "),oa=(c.height-64)/4,T=new Uint8Array(128),pa=new Uint8Array(1024);navigator.mediaDevices.getUserMedia({audio:!0}).then(function(d){ea=d;N=new MediaRecorder(d);N.ondataavailable=function(d){R[A].b.src=URL.createObjectURL(d.data);n=M.currentTime-L;R[A].b.currentTime=.1+n+R[A].of;R[A].b.play();A=0};c.onmousedown()});for(var U=0;6>U;++U)R[U]={},R[U].of=0,0<U&&(R[U].b=new Audio);
var qa=new function(){function d(b){return Math.sin(6.283184*b)}var t=[d,function(b){return.5>b%1?1:-1},function(b){return b%1*2-1},function(b){b=b%1*4;return 2>b?b-1:3-b}],k,f,e,v,l;this.s=function(){var b={v:[{a:[0,255,116,1,0,255,116,0,1,0,4,6,35,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[1],f:[{n:[135,,135,,,,135,135,,,135,,,,135,,135,,135,,,,135,135,,,135,,,,135],h:[]}]},{a:[0,160,128,1,0,160,128,0,1,210,4,7,41,0,0,0,60,4,1,2,255,0,0,32,61,5,32,6],p:[1],f:[{n:[,,,,135,,,,,,,,135,,,,,,,,135,,,,,,,,135],
h:[]}]},{a:[0,0,140,0,0,0,140,0,0,60,4,10,34,0,0,0,187,5,0,1,239,135,0,32,108,5,16,4],p:[1],f:[{n:[135,,135,,,,135,135,135,,135,,,,135,135,135,,135,,,,135,135,135,,135,,,,135],h:[]}]}],j:5513,i:32,m:0,u:3};k=b;f=b.m;e=0;v=b.j*b.i*(f+1)*2;l=new Int32Array(v)};this.o=function(){var b,B,y,g,w,r=new Int32Array(v),p=k.v[e],J=k.j,V=k.i,ia=0,W=0,C;var D=!1;var X=[];for(B=0;B<=f;++B){var O=p.p[B];for(y=0;y<V;++y){if(w=O?p.f[O-1].h[y]:0)p.a[w-1]=p.f[O-1].h[y+V]||0,16>w&&(X=[]);var Ba=t[p.a[15]],Ca=p.a[16]/
512,Da=Math.pow(2,p.a[17]-9)/J,Ea=p.a[18],sa=p.a[19],Fa=135.82764118168*p.a[20]/44100,Ga=1-p.a[21]/255,ja=1E-5*p.a[22],Ha=p.a[23]/32,Ia=p.a[24]/512,Ja=6.283184*Math.pow(2,p.a[25]-9)/J,ta=p.a[26]/255,ka=p.a[27]*J&-2;w=(B*V+y)*J;for(g=0;4>g;++g)if(b=O?p.f[O-1].n[y+g*V]:0){if(!X[b]){var m=X;var F=b;var ua=C=void 0,Y,E,q=p,va=b,Ka=t[q.a[0]],La=q.a[1],Ma=q.a[3],Na=t[q.a[4]],Oa=q.a[5],Pa=q.a[8],wa=q.a[9],K=q.a[10]*q.a[10]*4,Z=q.a[11]*q.a[11]*4,la=q.a[12]*q.a[12]*4,Qa=1/la,P=q.a[13],Ra=J*Math.pow(2,2-q.a[14]),
xa=new Int32Array(K+Z+la),ya=0,za=0;for(Y=E=0;E<K+Z+la;E++,Y++){0<=Y&&(P=P>>8|(P&255)<<4,Y-=Ra,ua=.003959503758*Math.pow(2,(va+(P&15)+q.a[2]-128-128)/12),C=.003959503758*Math.pow(2,(va+(P&15)+q.a[6]-128-128)/12)*(1+8E-4*q.a[7]));var G=1;E<K?G=E/K:E>=K+Z&&(G-=(E-K-Z)*Qa);var Q=ua;Ma&&(Q*=G*G);ya+=Q;var ma=Ka(ya)*La;Q=C;Pa&&(Q*=G*G);za+=Q;ma+=Na(za)*Oa;wa&&(ma+=(2*Math.random()-1)*wa);xa[E]=80*ma*G|0}m[F]=xa}F=X[b];b=0;for(m=2*w;b<F.length;b++,m+=2)r[m]+=F[b]}for(b=0;b<J;b++)g=2*(w+b),(m=r[g])||D?(D=
Fa,Ea&&(D*=Ba(Da*g)*Ca+.5),D=1.5*Math.sin(D),ia+=D*W,m=Ga*(m-W)-ia,W+=D*m,m=3==sa?W:1==sa?m:ia,ja&&(m*=ja,m=1>m?-1<m?d(.25*m):-1:1,m/=ja),m*=Ha,D=1E-5<m*m,F=Math.sin(Ja*g)*Ia+.5,C=m*(1-F),m*=F):C=0,g>=ka&&(C+=r[g-ka+1]*ta,m+=r[g-ka]*ta),r[g]=C|0,r[g+1]=m|0,l[g]+=C|0,l[g+1]+=m|0}}e++;return e/k.u};this.l=function(){var b=44+2*v-8,d=b-36,e=new Uint8Array(44+2*v);e.set([82,73,70,70,b&255,b>>8&255,b>>16&255,b>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,
97,d&255,d>>8&255,d>>16&255,d>>24&255]);b=0;for(d=44;b<v;++b){var g=l[b];g=-32767>g?-32767:32767<g?32767:g;e[d++]=g&255;e[d++]=g>>8&255}return e};this.getData=function(b,d){for(var e=2*Math.floor(44100*b),g=Array(d),f=0;f<2*d;f+=1){var k=e+f;g[f]=0<b&&k<l.length?l[k]/32768:0}return g}};qa.s();var ra=setInterval(function(){(da=1<=qa.o())&&clearInterval(ra)},0);
c.onmousedown=function(d){if(M)(d=Math.ceil(((d.touches?d.touches[0].pageY:d.pageY)-c.offsetTop-64)/oa))&&x?z||(A=A!=d?d:0):u?(u=0,ca=!ca):x?u=1:(L=M.currentTime,Aa());else if(ea&&da){M=new (window.AudioContext||window.webkitAudioContext);I=M.createAnalyser();I.connect(M.destination);H=M.createGain();H.connect(I);for(d=0;6>d;++d)if(R[d].c=M.createAnalyser(),R[d].c.fftSize=2*T.length,5>d&&R[d].c.connect(H),5==d){var t=M.createMediaStreamSource(ea);t.connect(R[d].c)}else d&&(t=M.createMediaElementSource(R[d].b),
t.connect(R[d].c));d=qa.l();M.decodeAudioData(d.buffer,function(d){R[0].g=d;L=M.currentTime;Aa();Sa(0)})}};function Aa(){u=0;x=1;for(var d=0;5>d;++d)R[d].g?Ta(d):R[d].b.src&&(R[d].b.currentTime=M.currentTime-L+.1,R[d].b.play());n=0}
function Ta(d){var t=M.createBufferSource();t.buffer=R[d].g;t.connect(R[d].c);t.start(0);d||(t.onended=function(){u?x=u=0:(L=M.currentTime,N&&A&&(z?(N.stop(),z=0,H.gain.setValueAtTime(1,M.currentTime),n=M.currentTime-L,R[A].of+=n):(H.gain.setValueAtTime(.1,M.currentTime),N.start(),z=1,R[A].of=n=M.currentTime-L)),Aa())})}
function Sa(d){function t(d){d=Math.sin(2*(B+d)*Math.PI);l=a.createRadialGradient(w+16,b-8*d,0,w+16,b-8*d,48);l.addColorStop(0,"rgba(191,255,255,0)");l.addColorStop(1,"rgba(191,255,255,1)");a.fillStyle=l;a.beginPath();a.moveTo(w,b);a.quadraticCurveTo(w+40,b-16-16*d,w+48,b-16*d);a.quadraticCurveTo(w+40,b+16-16*d,w,b);a.fill()}a.clearRect(0,0,c.width,c.height);var k=c.width/T.length;a.lineWidth=1;for(var f=0;5>f;++f)if(!f||R[f].b.src)if(R[f].c.getByteFrequencyData(T),ca)for(var e=T.length-1;0<=e;--e){var v=
T[e]/-255*c.height,l=a.createLinearGradient(0,c.height,0,c.height+v);l.addColorStop(0,"rgba(0,0,0,0)");l.addColorStop(1,u?"#000":S[f]);a.fillStyle=l;a.fillRect((e+f/5)*k,c.height,1,v)}else{a.strokeStyle=u?"#000":S[f];a.beginPath();for(e=T.length/2;0<=e;--e){var b=541-2*T[e];a.moveTo(15*(e+1),b);a.lineTo(15*e,b)}a.stroke()}k=(pa.length-c.width)/2;I.getByteTimeDomainData(pa);a.fillStyle="#000";a.beginPath();a.moveTo(c.width,0);for(f=c.width;0<=f;--f)a.lineTo(f,pa[f+k]/2);a.lineTo(0,0);a.fill();k=((L-
M.currentTime)/R[0].g.duration+1)*c.width;a.lineWidth=2;a.strokeStyle="#fff";a.beginPath();for(f=1;5>f;++f)if(b=oa*(f-.5)+64,z&&f==A)for(R[5].c.getByteTimeDomainData(T),a.moveTo(k+64,b),v=(k+64)/T.length,e=T.length-1;0<=e;--e)a.lineTo(v*e,b+(T[e]-128)/2);else if(R[f].b.src)for(R[f].c.getByteTimeDomainData(T),a.moveTo(k+64,b),e=T.length-1;0<=e;--e)a.lineTo(k-64+e,b+(T[e]-128)/4);a.stroke();var B=(M.currentTime-L)%(R[0].g.duration/4);e=Math.sin(2*B*Math.PI);v=80+4*e;var y=k-56,g=k-48,w=k+80;for(f=1;5>
f;++f){b=oa*(f-.5)+64;l=a.createRadialGradient(k-32,b,0,k,b,80+4*e);l.addColorStop(0,"rgba(255,255,255,0)");l.addColorStop(1,f==A?S[5]:S[f]);a.fillStyle=l;a.beginPath();a.moveTo(k-64,b);a.lineTo(k-80,b-8);a.quadraticCurveTo(k,b-v,k+80,b);a.quadraticCurveTo(k,b+v,k-80,b+8);a.fill();var r=b-16-e;l=a.createRadialGradient(y,r,0,y,r,16);l.addColorStop(0,"rgba(255,255,255,0)");l.addColorStop(1,"rgba(255,255,255,1)");a.fillStyle=l;a.beginPath();a.ellipse(y,r,8,12,0,0,2*Math.PI);a.fill();r=b-32-2*e;l=a.createRadialGradient(g+
32,r-4*e,0,g+32,r-4*e,32);l.addColorStop(0,"rgba(255,255,191,0)");l.addColorStop(1,"rgba(255,255,191,1)");a.fillStyle=l;a.beginPath();a.moveTo(g,r);a.quadraticCurveTo(g+32,r-32-8*e,g+64,r-16-8*e);a.fill();t(0);t(1/3);t(2/3)}fa++;984<d-ha&&(na=fa+"fps",ha=d,fa=0);a.fillStyle="#fff";a.fillText(na,1,12);requestAnimationFrame(Sa)};